# Contributors: @copilot
# Automatically adds a reminder comment to draft PRs to help reduce draft PRs without descriptions or reviewers
# < as per SSW.Rules: https://www.ssw.com.au/rules/standard-set-of-pull-request-workflows/ >

name: "PR - Draft PR Reminder"

on:
  pull_request:
    types: [opened, converted_to_draft]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  draft_reminder:
    if: github.event.pull_request.draft == true
    runs-on: ubuntu-latest
    steps:
      - name: Determine target user and check for existing comment
        id: check_comment
        shell: pwsh
        run: |
          $prNumber = ${{ github.event.pull_request.number }}
          $prAuthor = "${{ github.event.pull_request.user.login }}"
          
          Write-Output "Checking PR #$prNumber (author: $prAuthor)..."
          
          # Function to check if a user is a bot
          function Test-IsBot {
            param($login)
            return $login -match '\[bot\]$' -or $login -eq 'dependabot' -or $login -eq 'renovate' -or $login -eq 'github-actions' -or $login -eq 'copilot'
          }
          
          # Check if PR author is a bot
          $authorIsBot = Test-IsBot $prAuthor
          
          $targetUser = $prAuthor
          
          if ($authorIsBot) {
            Write-Output "PR author is a bot, looking for first non-bot commit author..."
            
            # Get commits from the PR
            try {
              $commitsJson = gh pr view $prNumber --repo '${{ github.repository }}' --json commits | ConvertFrom-Json
              
              if ($commitsJson.commits -and $commitsJson.commits.Count -gt 0) {
                $foundNonBotUser = $false
                foreach ($commit in $commitsJson.commits) {
                  # Check if commit author exists and has a login
                  if ($commit.author -and $commit.author.login) {
                    $commitAuthor = $commit.author.login
                    
                    if (-not (Test-IsBot $commitAuthor)) {
                      $targetUser = $commitAuthor
                      $foundNonBotUser = $true
                      Write-Output "Found non-bot user: $targetUser"
                      break
                    }
                  }
                }
                
                if (-not $foundNonBotUser) {
                  Write-Output "No non-bot user found in commits. Skipping workflow."
                  echo "skip=true" >> $env:GITHUB_OUTPUT
                  exit 0
                }
              } else {
                Write-Output "No commits found in PR. Skipping workflow."
                echo "skip=true" >> $env:GITHUB_OUTPUT
                exit 0
              }
            } catch {
              Write-Output "Failed to fetch PR commits: $_"
              Write-Output "Skipping workflow."
              echo "skip=true" >> $env:GITHUB_OUTPUT
              exit 0
            }
          }
          
          # Get all comments on the PR and check if reminder exists
          $commentsJson = gh pr view $prNumber --repo '${{ github.repository }}' --json comments | ConvertFrom-Json
          
          # Check if our reminder comment already exists
          $reminderExists = $false
          foreach ($comment in $commentsJson.comments) {
            # Check for both 'github-actions' and 'github-actions[bot]' to handle API variations
            $isBot = $comment.author.login -eq "github-actions" -or $comment.author.login -eq "github-actions[bot]"
            if ($isBot -and $comment.body -match "This PR is currently in Draft mode") {
              $reminderExists = $true
              Write-Output "Reminder comment already exists"
              break
            }
          }
          
          if ($reminderExists) {
            echo "skip=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "skip=false" >> $env:GITHUB_OUTPUT
          }
          
          echo "target_user=$targetUser" >> $env:GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add draft PR reminder comment
        if: steps.check_comment.outputs.skip == 'false'
        shell: pwsh
        run: |
          $prNumber = ${{ github.event.pull_request.number }}
          $author = "${{ steps.check_comment.outputs.target_user }}"
          
          Write-Output "Adding reminder comment to PR #$prNumber for @$author"
          
          $comment = @"
          üëã Hi @$author,

          This PR is currently in **Draft mode**. To help it get reviewed and merged:

          1. ‚úçÔ∏è **Add a description** - Explain what changes you've made and why
          2. ‚úÖ **Mark as ready for review** - Click "Ready for review" when you're done
          3. üë• **Add reviewers** - Assign people to review your changes

          Once you've completed these steps, your PR will be ready for approval!

          _This is an automated reminder to help reduce draft PRs without descriptions or reviewers._
          "@
          
          # Create a unique temporary file
          $tempFile = [System.IO.Path]::GetTempFileName()
          Set-Content -Path $tempFile -Value $comment
          gh pr comment $prNumber --repo '${{ github.repository }}' --body-file $tempFile
          Remove-Item $tempFile -Force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
